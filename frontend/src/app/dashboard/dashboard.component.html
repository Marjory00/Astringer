<div class="dashboard-container">

    <h1><i class="fas fa-microchip"></i> System Health Monitor</h1>

    <div class="system-health-grid">
        <div
            class="health-card"
            *ngFor="let health of systemHealth"
            [ngClass]="getHealthClass(health.status)"
            role="region"
            aria-label="{{ health.name }} status"
        >
            <h2>{{ health.name }}</h2>
            <i class="fas" [ngClass]="getHealthIcon(health.status)" aria-hidden="true"></i>
            <p class="status-text">{{ health.status }}</p>
            <small>Latency: {{ health.latency }} ms</small>
        </div>
    </div>

    <hr />

    <h2><i class="fas fa-tachometer-alt"></i> Operational Performance Metrics</h2>

    <div class="row operational-kpis-container mb-4">
        <div *ngIf="operationalKpi$ | async as kpis" class="d-flex flex-wrap w-100">
            <div class="col-md-4 mb-3" *ngFor="let kpi of kpis">
                <div class="kpi-card text-white" [ngClass]="kpi.colorClass">
                    <div class="kpi-body">
                        <h5 class="kpi-title">{{ kpi.title }}</h5>
                        <div class="kpi-value-container">
                            <p class="kpi-value">{{ kpi.value }}</p>
                            <i class="fas kpi-trend"
                               [ngClass]="{
                                   'fa-arrow-up text-success': kpi.trend === 'up',
                                   'fa-arrow-down text-danger': kpi.trend === 'down',
                                   'fa-minus text-secondary': kpi.trend === 'stable'
                               }">
                            </i>
                        </div>
                        <i class="fas kpi-icon" [ngClass]="kpi.icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr />

    <div class="row">
        <div class="col-md-8">
            <h2><i class="fas fa-map-marked-alt"></i> Active Shipment Locations</h2>
            <div class="map-placeholder">
                <p>

                </p>
                <p>
                    **Visual Map:** Displays all active shipments and potential route congestion.
                </p>
            </div>
        </div>

        <div class="col-md-4">
            <h2><i class="fas fa-fire"></i> Operational Hotspots</h2>
            <div *ngIf="displayShipments$ | async as shipments" class="hotspot-list">
                <div *ngIf="shipments.length > 0; else noHotspots" class="hotspot-item">
                    <p>
                        **Busiest Origin:** **Newark, NJ** (5 active routes)
                        <span class="badge bg-primary">High Traffic</span>
                    </p>
                    <p>
                        **Most Common Destination:** **Chicago, IL** (4 shipments)
                        <span class="badge bg-secondary">Monitoring</span>
                    </p>
                    <p>
                        **Exception City:** **Memphis, TN** (2 recent issues)
                        <span class="badge bg-danger">Critical</span>
                    </p>
                </div>
                <ng-template #noHotspots>
                    <div class="alert alert-info">No active shipments to identify hotspots.</div>
                </ng-template>
            </div>
        </div>
    </div>

    <hr />

    <h1><i class="fas fa-truck"></i> Active Shipments Overview</h1>

    <div *ngIf="isLoading" class="loading-state" aria-live="polite">
        <i class="fas fa-spinner fa-spin"></i> Loading active shipments...
    </div>

    <div *ngIf="apiError && !isLoading" class="error-state" role="alert">
        <i class="fas fa-exclamation-triangle"></i> {{ apiError }}
    </div>

    <div *ngIf="!isLoading && !apiError" class="row mb-4">
        <div class="col-12">
            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                </div>
                <input type="text"
                        class="form-control"
                        placeholder="Search by Tracking ID, Origin, or Destination..."
                        (keyup)="onSearch($event)">
            </div>
        </div>
    </div>

    <ng-container *ngIf="!isLoading && !apiError">
        <ng-container *ngIf="(displayShipments$ | async) as shipments; else noData">
            <div *ngIf="shipments.length > 0" class="shipments-table-container">
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Tracking ID</th>
                            <th scope="col">Origin</th>
                            <th scope="col">Destination</th>
                            <th scope="col">Est. Delivery</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let shipment of shipments">
                            <td class="id-link">
                                <a [routerLink]="['/track', shipment.trackingId]">{{ shipment.trackingId }}</a>
                            </td>
                            <td>{{ shipment.origin }}</td>
                            <td>{{ shipment.destination }}</td>
                            <td class="delivery-date">{{ shipment.estimatedDelivery | date: 'shortDate' }}</td>
                            <td>
                                <span class="status" [ngClass]="shipment.status | lowercase">
                                    <i class="fas" [ngClass]="getStatusIcon(shipment.status)" aria-hidden="true"></i>
                                    {{ shipment.status }}
                                </span>
                            </td>
                            <td>
                                <button (click)="navigateToTracking(shipment.trackingId)" class="action-btn">
                                    <i class="fas fa-search"></i> Details
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </ng-container>
    </ng-container>

    <ng-template #noData>
        <div class="empty-state" role="note">
            <i class="fas fa-box-open"></i> No active shipments found. Time to plan a new route!
            <a routerLink="/planning" class="plan-link">Plan New Shipment</a>
        </div>
    </ng-template>

    <hr>

    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-history"></i> Recent Activity Log</h2>
            <div class="list-group">
                <div *ngFor="let activity of recentActivity" class="list-group-item d-flex justify-content-between align-items-start">
                    <div class="me-auto">
                        <div class="fw-bold">
                            <i class="fas {{ activity.icon }} me-2"></i>
                            {{ activity.type }}
                        </div>
                        <small>{{ activity.message }}</small>
                    </div>
                    <span class="badge bg-secondary rounded-pill">{{ activity.time }}</span>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="!isLoading" class="dashboard-actions mt-4">
        <a routerLink="/planning" class="primary-button">
            <i class="fas fa-plus-circle"></i> Create New Shipment
        </a>
    </div>
</div>
